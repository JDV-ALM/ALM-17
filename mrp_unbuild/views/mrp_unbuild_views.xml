<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ============================================ -->
    <!-- VISTAS PARA MRP.BOM (Lista de Desposte) -->
    <!-- ============================================ -->
    
    <!-- Vista Form de BoM - Heredar y agregar campos de desposte -->
    <record id="mrp_bom_form_view_unbuild" model="ir.ui.view">
        <field name="name">mrp.bom.form.unbuild</field>
        <field name="model">mrp.bom</field>
        <field name="inherit_id" ref="mrp.mrp_bom_form_view"/>
        <field name="arch" type="xml">
            <!-- Agregar campo is_unbuild invisible para condicionales -->
            <field name="type" position="after">
                <field name="is_unbuild" invisible="1"/>
            </field>
            
            <!-- Cambiar label de Components cuando es unbuild -->
            <xpath expr="//page[@name='components']" position="attributes">
                <attribute name="string" invisible="not is_unbuild">Output Products</attribute>
            </xpath>
            
            <!-- Ocultar tab de Operations para unbuild -->
            <xpath expr="//page[@name='operations']" position="attributes">
                <attribute name="invisible">is_unbuild</attribute>
            </xpath>
            
            <!-- Ocultar tab de By-products para unbuild -->
            <xpath expr="//page[@name='by_products']" position="attributes">
                <attribute name="invisible">is_unbuild</attribute>
            </xpath>
            
            <!-- Agregar nuevo tab para Yields esperados en unbuild -->
            <xpath expr="//notebook" position="inside">
                <page string="Expected Yields" name="unbuild_yields" invisible="not is_unbuild">
                    <field name="unbuild_yield_ids">
                        <tree editable="bottom" decoration-warning="is_waste" decoration-danger="cost_share > 100">
                            <field name="sequence" widget="handle"/>
                            <field name="product_id" domain="[('type', 'in', ['product', 'consu'])]" required="1"/>
                            <field name="expected_qty"/>
                            <field name="product_uom_id" groups="uom.group_uom" options="{'no_open': True, 'no_create': True}"/>
                            <field name="cost_share" sum="Total" widget="percentage"/>
                            <field name="is_waste"/>
                        </tree>
                        <form>
                            <group>
                                <group>
                                    <field name="product_id"/>
                                    <field name="expected_qty"/>
                                    <field name="product_uom_id" groups="uom.group_uom"/>
                                </group>
                                <group>
                                    <field name="cost_share"/>
                                    <field name="is_waste"/>
                                </group>
                            </group>
                        </form>
                    </field>
                    <group class="oe_subtotal_footer">
                        <div class="oe_subtotal_footer_separator">
                            <label for="id" string="Total Cost Share"/>
                            <field name="id" invisible="1"/>
                        </div>
                        <div class="text-muted">
                            <span>The total cost share allocated is </span>
                            <field name="id" invisible="1"/>
                            <span class="fw-bold" style="color: red;" invisible="context.get('total_cost_share', 0) > 100">
                                Warning: Total exceeds 100%
                            </span>
                        </div>
                    </group>
                </page>
            </xpath>
            
            <!-- Modificar el campo product_qty label según tipo -->
            <xpath expr="//label[@for='product_qty']" position="attributes">
                <attribute name="string" invisible="not is_unbuild">Input Quantity</attribute>
            </xpath>
        </field>
    </record>
    
    <!-- Vista Tree de BoM - Agregar columna tipo -->
    <record id="mrp_bom_tree_view_unbuild" model="ir.ui.view">
        <field name="name">mrp.bom.tree.unbuild</field>
        <field name="model">mrp.bom</field>
        <field name="inherit_id" ref="mrp.mrp_bom_tree_view"/>
        <field name="arch" type="xml">
            <field name="product_tmpl_id" position="after">
                <field name="type" decoration-info="type == 'unbuild'" decoration-bf="type == 'unbuild'"/>
            </field>
        </field>
    </record>
    
    <!-- ============================================ -->
    <!-- VISTAS PARA MRP.PRODUCTION (Órdenes Desposte) -->
    <!-- ============================================ -->
    
    <!-- Vista Form de Production - Adaptar para desposte -->
    <record id="mrp_production_form_view_unbuild" model="ir.ui.view">
        <field name="name">mrp.production.form.unbuild</field>
        <field name="model">mrp.production</field>
        <field name="inherit_id" ref="mrp.mrp_production_form_view"/>
        <field name="arch" type="xml">
            <!-- Agregar campos invisibles necesarios -->
            <field name="state" position="after">
                <field name="is_unbuild_order" invisible="1"/>
                <field name="has_sufficient_stock" invisible="1"/>
                <field name="total_cost_allocation" invisible="1"/>
            </field>
            
            <!-- Cambiar título del form según tipo -->
            <xpath expr="//form" position="attributes">
                <attribute name="string" invisible="not is_unbuild_order">Unbuild Orders</attribute>
            </xpath>
            
            <!-- Agregar alerta de stock insuficiente -->
            <xpath expr="//header" position="before">
                <div class="alert alert-warning text-center" role="alert" invisible="has_sufficient_stock or not is_unbuild_order or state != 'draft'">
                    <strong>Insufficient Stock!</strong> There is not enough stock available for this unbuild operation.
                </div>
            </xpath>
            
            <!-- Cambiar label de referencia -->
            <xpath expr="//label[@for='name']" position="attributes">
                <attribute name="string" invisible="not is_unbuild_order">UO Reference</attribute>
            </xpath>
            
            <!-- Modificar placeholder del name -->
            <xpath expr="//field[@name='name']" position="attributes">
                <attribute name="placeholder" invisible="not is_unbuild_order">e.g. UO/00001</attribute>
            </xpath>
            
            <!-- Cambiar label de cantidad -->
            <xpath expr="//label[@for='product_qty']" position="attributes">
                <attribute name="string" invisible="not is_unbuild_order">Quantity to Unbuild</attribute>
            </xpath>
            
            <!-- Cambiar string de To Produce -->
            <xpath expr="//span[@class='o_line_break']" position="replace">
                <span class='o_line_break' invisible="is_unbuild_order">To Produce</span>
                <span class='o_line_break' invisible="not is_unbuild_order">To Unbuild</span>
            </xpath>
            
            <!-- Ocultar tab Components para unbuild -->
            <xpath expr="//page[@name='components']" position="attributes">
                <attribute name="invisible">is_unbuild_order</attribute>
            </xpath>
            
            <!-- Ocultar tab Work Orders para unbuild -->
            <xpath expr="//page[@name='operations']" position="attributes">
                <attribute name="invisible">is_unbuild_order</attribute>
            </xpath>
            
            <!-- Cambiar título de Finished Products a Output Products -->
            <xpath expr="//page[@name='finished_products']" position="attributes">
                <attribute name="string" invisible="not is_unbuild_order">Output Products</attribute>
            </xpath>
            
            <!-- Agregar tab de Yields para captura de rendimientos -->
            <xpath expr="//notebook" position="inside">
                <page string="Actual Yields" name="unbuild_yields" invisible="not is_unbuild_order">
                    <group invisible="state in ['draft', 'cancel']">
                        <group>
                            <field name="unbuild_efficiency" widget="progressbar" options="{'current_value': 'unbuild_efficiency', 'max_value': 100}"/>
                            <field name="total_waste_qty"/>
                        </group>
                        <group>
                            <field name="unbuild_total_cost" widget="monetary" groups="mrp.group_mrp_manager"/>
                            <field name="unbuild_allocated_cost" widget="monetary" groups="mrp.group_mrp_manager"/>
                            <field name="unbuild_unallocated_cost" widget="monetary" groups="mrp.group_mrp_manager" 
                                   decoration-danger="unbuild_unallocated_cost > 0"/>
                        </group>
                    </group>
                    <field name="unbuild_yield_line_ids" invisible="state == 'draft'">
                        <tree editable="bottom" 
                              decoration-success="variance_percent &gt;= -5 and variance_percent &lt;= 5" 
                              decoration-warning="variance_percent &lt; -5 and variance_percent &gt; -10 or variance_percent &gt; 5 and variance_percent &lt; 10"
                              decoration-danger="variance_percent &lt;= -10 or variance_percent &gt;= 10">
                            <field name="sequence" widget="handle"/>
                            <field name="product_id" readonly="1" force_save="1"/>
                            <field name="expected_qty" readonly="1" force_save="1"/>
                            <field name="actual_qty" readonly="state == 'done'"/>
                            <field name="product_uom_id" readonly="1" groups="uom.group_uom" force_save="1"/>
                            <field name="variance" readonly="1" decoration-danger="variance &lt; 0"/>
                            <field name="variance_percent" widget="percentage" readonly="1"/>
                            <field name="cost_share" readonly="1" widget="percentage" force_save="1"/>
                            <field name="allocated_cost" widget="monetary" groups="mrp.group_mrp_manager" optional="show"/>
                            <field name="unit_cost" widget="monetary" groups="mrp.group_mrp_manager" optional="hide"/>
                            <field name="is_waste" readonly="1" force_save="1"/>
                            <field name="production_id" invisible="1"/>
                            <field name="state" invisible="1"/>
                            <field name="currency_id" invisible="1"/>
                        </tree>
                    </field>
                    <group>
                        <group>
                            <button name="action_apply_expected" 
                                    string="Apply Expected Quantities" 
                                    type="object" 
                                    class="btn-secondary"
                                    invisible="state in ['done', 'cancel']"
                                    groups="mrp.group_mrp_user"/>
                        </group>
                    </group>
                </page>
                
                <!-- Tab de análisis de costos -->
                <page string="Cost Analysis" name="unbuild_costs" invisible="not is_unbuild_order" groups="mrp.group_mrp_manager">
                    <group>
                        <group string="Input Cost">
                            <field name="unbuild_total_cost" widget="monetary"/>
                        </group>
                        <group string="Cost Distribution">
                            <field name="unbuild_allocated_cost" widget="monetary"/>
                            <field name="unbuild_waste_cost" widget="monetary"/>
                            <field name="unbuild_unallocated_cost" widget="monetary" decoration-danger="unbuild_unallocated_cost > 0"/>
                            <field name="total_cost_allocation" widget="percentage"/>
                        </group>
                    </group>
                    <div class="alert alert-info" role="alert" invisible="total_cost_allocation >= 100">
                        <i class="fa fa-info-circle"/> 
                        <strong>Note:</strong> 
                        <span>Only </span>
                        <field name="total_cost_allocation" nolabel="1" class="oe_inline"/>% 
                        <span> of the total cost has been allocated. The remaining will be posted to the loss account.</span>
                    </div>
                </page>
            </xpath>
            
            <!-- Modificar dominio del bom_id según tipo -->
            <xpath expr="//field[@name='bom_id']" position="attributes">
                <attribute name="context">{'default_type': is_unbuild_order and 'unbuild' or 'normal'}</attribute>
            </xpath>
            
            <!-- Agregar indicador de stock en el campo producto -->
            <xpath expr="//field[@name='product_id']" position="after">
                <div invisible="not is_unbuild_order or state != 'draft'" class="text-muted">
                    <i class="fa fa-info-circle"/> Available stock will be checked before confirmation
                </div>
            </xpath>
        </field>
    </record>
    
    <!-- Vista Tree de Production para órdenes de desposte -->
    <record id="mrp_production_tree_view_unbuild" model="ir.ui.view">
        <field name="name">mrp.production.tree.unbuild</field>
        <field name="model">mrp.production</field>
        <field name="inherit_id" ref="mrp.mrp_production_tree_view"/>
        <field name="arch" type="xml">
            <!-- Agregar columna para identificar tipo -->
            <field name="product_id" position="after">
                <field name="is_unbuild_order" optional="hide" string="Type" widget="badge" 
                       decoration-info="is_unbuild_order"/>
            </field>
            <!-- Agregar eficiencia para órdenes de desposte -->
            <field name="date_start" position="after">
                <field name="unbuild_efficiency" string="Efficiency" widget="percentage" optional="show"
                       invisible="not is_unbuild_order"
                       decoration-success="unbuild_efficiency >= 95"
                       decoration-warning="unbuild_efficiency >= 85 and unbuild_efficiency &lt; 95"
                       decoration-danger="unbuild_efficiency &lt; 85"/>
            </field>
        </field>
    </record>
    
    <!-- Vista Kanban - Agregar indicador de desposte -->
    <record id="mrp_production_kanban_view_unbuild" model="ir.ui.view">
        <field name="name">mrp.production.kanban.unbuild</field>
        <field name="model">mrp.production</field>
        <field name="inherit_id" ref="mrp.mrp_production_kanban_view"/>
        <field name="arch" type="xml">
            <xpath expr="//kanban" position="inside">
                <field name="is_unbuild_order"/>
                <field name="unbuild_efficiency"/>
            </xpath>
            <xpath expr="//div[hasclass('o_kanban_record_title')]" position="inside">
                <span class="badge badge-info float-right" invisible="not is_unbuild_order">
                    <i class="fa fa-recycle"/> Unbuild
                </span>
            </xpath>
            <xpath expr="//div[hasclass('o_kanban_record_bottom')]" position="inside">
                <div invisible="not is_unbuild_order or unbuild_efficiency == 0">
                    <span class="text-muted">Efficiency: </span>
                    <field name="unbuild_efficiency" widget="percentage"/>
                </div>
            </xpath>
        </field>
    </record>
    
    <!-- Vista Search para filtrar órdenes de desposte -->
    <record id="view_mrp_production_filter_unbuild" model="ir.ui.view">
        <field name="name">mrp.production.select.unbuild</field>
        <field name="model">mrp.production</field>
        <field name="inherit_id" ref="mrp.view_mrp_production_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <separator/>
                <filter string="Manufacturing Orders" name="manufacturing_orders" domain="[('is_unbuild_order', '=', False)]"/>
                <filter string="Unbuild Orders" name="unbuild_orders" domain="[('is_unbuild_order', '=', True)]"/>
                <separator/>
                <filter string="Low Efficiency (&lt; 85%)" name="low_efficiency" 
                        domain="[('is_unbuild_order', '=', True), ('unbuild_efficiency', '&lt;', 85)]"/>
                <filter string="Unallocated Costs" name="unallocated_costs" 
                        domain="[('is_unbuild_order', '=', True), ('unbuild_unallocated_cost', '&gt;', 0)]"
                        groups="mrp.group_mrp_manager"/>
            </xpath>
            <xpath expr="//filter[@name='activities_overdue']" position="after">
                <separator/>
                <filter string="Insufficient Stock" name="insufficient_stock" 
                        domain="[('is_unbuild_order', '=', True), ('has_sufficient_stock', '=', False), ('state', '=', 'draft')]"
                        help="Unbuild orders with insufficient stock"/>
            </xpath>
        </field>
    </record>
    
    <!-- ============================================ -->
    <!-- ACCIONES Y MENÚS -->
    <!-- ============================================ -->
    
    <!-- Acción para BoMs de tipo Unbuild -->
    <record id="mrp_bom_unbuild_action" model="ir.actions.act_window">
        <field name="name">Unbuild BoMs</field>
        <field name="res_model">mrp.bom</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('type', '=', 'unbuild')]</field>
        <field name="context">{'default_type': 'unbuild'}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create an Unbuild Bill of Materials
            </p>
            <p>
                Unbuild BoMs define how to disassemble a product into multiple output products,
                specifying expected yields and cost distribution.
            </p>
        </field>
    </record>
    
    <!-- Acción para Órdenes de Desposte -->
    <record id="mrp_production_unbuild_action" model="ir.actions.act_window">
        <field name="name">Unbuild Orders</field>
        <field name="res_model">mrp.production</field>
        <field name="view_mode">tree,kanban,form,calendar,pivot,graph,activity</field>
        <field name="search_view_id" ref="mrp.view_mrp_production_filter"/>
        <field name="context">{
            'search_default_unbuild_orders': 1,
            'default_is_unbuild_order': True,
            'unbuild_mode': True
        }</field>
        <field name="domain">[('is_unbuild_order', '=', True)]</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create an Unbuild Order
            </p>
            <p>
                Unbuild Orders allow you to disassemble finished products into their components,
                tracking actual yields and managing cost distribution.
            </p>
        </field>
    </record>
    
    <!-- Acción Server para aplicar cantidades esperadas -->
    <record id="action_apply_expected_yields" model="ir.actions.server">
        <field name="name">Apply Expected Quantities</field>
        <field name="model_id" ref="model_mrp_production_unbuild_yield"/>
        <field name="binding_model_id" ref="model_mrp_production_unbuild_yield"/>
        <field name="state">code</field>
        <field name="code">
if records:
    records.action_apply_expected()
        </field>
    </record>
    
    <!-- Menús -->
    <menuitem id="menu_mrp_unbuild_root"
        name="Unbuild"
        parent="mrp.menu_mrp_root"
        sequence="15"
        groups="mrp_unbuild.group_mrp_unbuild_user"/>
    
    <menuitem id="menu_mrp_unbuild_orders"
        name="Unbuild Orders"
        action="mrp_production_unbuild_action"
        parent="menu_mrp_unbuild_root"
        sequence="10"/>
    
    <menuitem id="menu_mrp_unbuild_bom"
        name="Unbuild BoMs"
        action="mrp_bom_unbuild_action"
        parent="mrp.menu_mrp_configuration"
        sequence="25"
        groups="mrp_unbuild.group_mrp_unbuild_manager"/>
    
    <menuitem id="menu_mrp_unbuild_reporting"
        name="Reporting"
        parent="menu_mrp_unbuild_root"
        sequence="99"
        groups="mrp.group_mrp_manager"/>
    
    <menuitem id="menu_mrp_unbuild_analysis"
        name="Unbuild Analysis"
        parent="menu_mrp_unbuild_reporting"
        action="mrp.action_report_mrp_production"
        context="{'search_default_unbuild_orders': 1}"
        sequence="10"/>
</odoo>